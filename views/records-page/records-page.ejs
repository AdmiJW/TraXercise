<!DOCTYPE html>
<html lang="en">

	<head>
		<%- include('../shared/_head.ejs') %>

		<!-- Include styles -->
		<%- include('../shared/_global.style.ejs') %>

		<!-- Include custom scripts -->
	</head>

	<body>
		<!-- Container min height 100 vh : To push footer to the bottom -->
		<div class="min-vh-100 d-flex flex-column">
			<!-- Loading Modal -->
			<%- include('../shared/_loading-modal.ejs') %>

			<!-- Navbar -->
			<%- include('../shared/_navbar.ejs') %>

			<!-- Content -->
			<div class="flex-grow-1 d-flex justify-content-center">
				<main
					class="p-3 m-3 border rounded-3 shadow-sm"
					style="
						width: clamp(300px, 100%, 800px);
						background-color: rgba(255, 255, 255, 0.95);
					"
				>
					<h1 class="text-center px-3">My Records üóíÔ∏è</h1>
					<hr class="mx-4" />

					<form class="w-100" id="view-form">
						<div class="card">
							<div
								class="card-body text-dark shadow bg-light rounded p-2"
							>
								<h5 class="card-title">
									Provide your information to view exercise
									record
								</h5>
								<p class="card-text">Your name:</p>
								<input
									type="text"
									class="form-control"
									name="name"
									id="name"
									aria-describedby="nameDesc"
									required
								/>
								<button
									type="submit"
									class="btn btn-primary w-100 mt-2"
								>
									View Record üóíÔ∏è
								</button>
							</div>
						</div>
					</form>

					<!-- Update Modal -->
					<div class="modal fade" id="updateModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
						<div class="modal-dialog" role="document">
							<div class="modal-content">
							  <div class="modal-header">
								<h5 class="modal-title" id="exampleModalLabel">Update Exercise</h5>
								<button type="button" class="close" data-dismiss="modal" aria-label="Close">
								  <span aria-hidden="true">&times;</span>
								</button>
							  </div>
							  <div class="modal-body">
								
							  </div>
							</div>
						</div>
					</div>

					<div id="resultSection" style="display: none"></div>
				</main>
			</div>
		</div>

		<%- include('../shared/_footer.ejs') %>
	</body>

	<script>
		const result_card =
			'<div class="card mt-3">' +
			'<h3 class="card-title text-center py-2"></h3>' +
			'<div id="exerciseData" class="w-100 d-flex align-content-start flex-wrap p-4">' +
			"</div>" +
			"</div>" +
			"</div>";

		function deleteExercise(id) {
			console.log("Deleting exercise with id: ");
			console.log(id);
			$.ajax({
				url: "/api/exercise-records/" + id,
				type: "DELETE",
				contentType: "application/json",
				success: function (data) {
					console.log(data);
					$("#resultSection").empty();
					$("#view-form").submit();
				},
				error: function (error) {
					console.log(error);
				},
			});
		}

		function updateExercise(id) {
			//show modal
			$("#updateModal").modal("show");
			//get exercise data and populate modal as form
			$.ajax({
				url: "/api/exercise-records/one/" + id,
				type: "GET",
				contentType: "application/json",
				success: function (data) {
					console.log(data);
					$("#updateModal .modal-title").text("Update Exercise");
					$("#updateModal .modal-body").empty();
					$("#updateModal .modal-body").append(
						'<form id="updateForm">' +
							'<div class="form-group">' +
							'<input type="hidden" class="form-control" id="name" disabled value="' +
							data.name +
							'">' +
							"</div>" +
							// radio option for type
							'<div class="form-group">' +
							'<label for="type">Type</label>' +
							'<div class="form-check">' +
							'<input class="form-check-input" type="radio" name="type" id="AEROBIC" value="AEROBIC">' +
							'<label class="form-check-label" for="AEROBIC">' +
							"Aerobic" +
							"</label>" +
							"</div>" +
							'<div class="form-check">' +
							'<input class="form-check-input" type="radio" name="type" id="ANAEROBIC" value="ANAEROBIC">' +
							'<label class="form-check-label" for="ANAEROBIC">' +
							"Anaerobic" +
							"</label>" +
							"</div>" +
							'<div class="form-check">' +
							'<input class="form-check-input" type="radio" name="type" id="HYBRID" value="HYBRID">' +
							'<label class="form-check-label" for="HYBRID">' +
							"Hybrid" +
							"</label>" +
							"</div>" +
							"</div>" +
							// activity
							'<div class="form-group">' +
							'<label for="activity">Activity</label>' +
							'<input type="text" class="form-control" id="activity" value="' +
							data.activity +
							'">' +
							"</div>" +
							'<div class="form-group">' +
							'<label for="duration">Duration</label>' +
							'<input type="number" class="form-control" id="duration" value="' +
							data.duration +
							'">' +
							"</div>" +
							'<div class="form-group">' +
							'<label for="date">Date</label>' +
							'<input type="date" class="form-control" id="date" value="' +
							new Date(data.date).toISOString().substring(0, 10) +
							'">' +
							"</div>" +
							'<button type="submit" class="btn btn-primary">Update</button>' +
							"</form>"
					);
					//make the data.type checked in the radio button
					$("#updateModal input[name='type'][value='" + data.type + "']").prop(
						"checked",
						true
					);
					$("#updateForm").submit(function (event) {
						event.preventDefault();
						let name = $("#name").val();
						let type = $("input[name='type']:checked").val();
						let activity = $("#activity").val();
						let duration = $("#duration").val();
						let date = $("#date").val();

						$.ajax({
							url: "/api/exercise-records/" + id,
							type: "PUT",
							contentType: "application/json",
							data: JSON.stringify({
								name: name,
								type: type,
								activity: activity,
								duration: parseInt(duration),
								date: date,
							}),
							success: function (data) {
								console.log(data);
								$("#updateModal").modal("hide");
								$("#resultSection").empty();
								$("#view-form").submit();
							},
							error: function (error) {
								console.log(type);
								console.log(duration);
								console.log(error);
							},
						});
					});
				},
				error: function (error) {
					console.log(error);
				},
			});
			
		}

		$(document).ready(function () {
			$("#view-form").submit(function (event) {
				showLoading();
				event.preventDefault();
				let name = $("#name").val();

				$.ajax({
					url: "/api/exercise-records/" + name,
					type: "GET",
					contentType: "application/json",
					success: function (data) {
						$("#resultSection").show();
						$("#resultSection").empty();

						if (data.length == 0) {
							const no_records_card = $(result_card);
							no_records_card
								.find(".card-title")
								.text("No records found for " + name);
							$("#resultSection").append(no_records_card);
							hideLoading();
							return;
						}
						console.log(data);
						const records_card = $(result_card);
						records_card
							.find(".card-title")
							.text(
								"üíæ " + data[0].name + "'s Exercise Records üíæ"
							);

						data.forEach(function (record) {
							records_card
								.find("#exerciseData")
								.append(
									'<div class="w-25 card-body text-dark shadow bg-success rounded p-2 m-2">' +
										'<h5 class="card-title">' +
										new Date(record.date)
											.toISOString()
											.substring(0, 10) +
										"</h5>" +
										"<p><strong>Exercise:</strong> " +
										record.activity +
										"<br>" +
										"<strong>Exercise Type:</strong>" +
										record.type +
										"<br>" +
										"<strong>Duration:</strong>" +
										record.duration +
										" minutes" +
										"</p>" +
										'<button type="button" class="btn btn-primary w-100 mt-2" data-toggle="modal" data-target="#updateModal" onclick="updateExercise(\'' +
										record.id +
										"')\"> Update üóíÔ∏è</button>" +
										'<button type="button" class="btn btn-danger w-100 mt-2" onclick="deleteExercise(\'' +
										record.id +
										"')\"> Delete üóíÔ∏è</button>" +
										"</div>"
								);
							$("#resultSection").append(records_card);
						});

						hideLoading();
					},
					error: function (err) {
						console.error("Error:", err);
						$("#resultCard").hide();
						alert("Error: " + err.message);
						setTimeout(hideLoading, 5000);
					},
				});
			});
		});
	</script>
</html>
